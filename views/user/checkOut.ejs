<%- include("../../views/partials/user/header") %>

    <style>
        .shipping-address-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    }

    .address-card {
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 15px;  
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .address-card.selected {
        border-color: #007bff;
        background: #f0f8ff;
    }

    .address-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: bold;
    }

    .address-header input[type="radio"] {
        margin-right: 10px;
    }

    .address-type {
        flex-grow: 1;
    }

    .edit-btn {
        background: none;
        border: 1px solid #007bff;
        padding: 5px 10px;
        border-radius: 5px;
        color: #007bff;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .edit-btn:hover {
        background: #007bff;
        color: #fff;
    }

    .address-details p {
        margin: 2px 0;
        font-size: 14px;
        color: #333;
    }

    .order-details-form {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }

    .order-details-form li {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem;
        align-items: center;
    }

    .order-details-form span {
        flex: 1;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    .order-details-form li:first-child {
        font-weight: bold;
    }

    .order-details-form li span:first-child {
        flex: 2; /* Increase the space for product name */
    }

    .order-details-form li span:nth-child(2) {
        flex: 1;
        text-align: center;
    }

    .order-details-form li span:nth-child(3) {
        flex: 1;
        text-align: right;
    }


    .no-charges {
        color: green;
        font-size: 14px;
    }   

        /* Modal background */
    .modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto; /* Enable scrolling if needed */
    background-color: rgba(0, 0, 0, 0.4); /* Background color */
    }

    /* Modal content */
    .modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 400px;
    }

    /* Close button */
    .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    }

    .close:hover,
    .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
    }

    .page-header.breadcrumb-wrap {
    background-color: #f5f5f5;
    border-radius: 8px;
  }

  .breadcrumb-container {
    font-family: Arial, sans-serif;
    font-size: 14px;
  }

  .breadcrumb {
    list-style: none;
    display: flex;
    align-items: center;
    padding-left: 50px;
    
  }

  .breadcrumb li {
    display: flex;
    align-items: center;
  }

  .breadcrumb a {
    text-decoration: none;
    color: #007bff;
    font-weight: 500;
    transition: color 0.3s ease;
  }

  .breadcrumb a:hover {
    color: #0056b3;
  }

  .breadcrumb span {
    margin: 0 8px;
    color: #555;
  }

  
  .coupon-card {
        background: #f8f9fa; /* Light gray background */
        border-radius: 8px;
        padding: 15px;
    }
    .coupon-content p {
        margin: 5px 0;
        font-size: 14px;
    }
    .coupon-code {
        font-size: 16px;
        font-weight: bold;
    }
    
    
    .coupon-buttons {
    display: flex;
    gap: 10px; /* Spacing between buttons */
    justify-content: center; /* Centers the buttons */
    margin-top: 15px;
    }

    .coupon-btn {
        padding: 8px 15px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
    }

    /* Apply Coupon Button */
    .apply-btn {
        background-color: #28a745; /* Green */
        color: white;
    }

    .apply-btn:hover {
        background-color: #218838; /* Darker Green */
    }

    /* Remove Coupon Button */
    .remove-btn {
        background-color: #dc3545; /* Red */
        color: white;
    }

    .remove-btn:hover {
        background-color: #c82333; /* Darker Red */
    }


    </style>

   


    <!-- ##### Right Side Cart Area ##### -->
    <div class="cart-bg-overlay"></div>

    <div class="right-side-cart-area">

        <!-- Cart Button -->
        <div class="cart-button">
            <a href="#" id="rightSideCart"><img src="img/core-img/bag.svg" alt=""> <span>3</span></a>
        </div>

        <div class="cart-content d-flex">

            <!-- Cart List Area -->
            <div class="cart-list">
                <!-- Single Cart Item -->
                <div class="single-cart-item">
                    <a href="#" class="product-image">
                        <img src="img/product-img/product-1.jpg" class="cart-thumb" alt="">
                        <!-- Cart Item Desc -->
                        <div class="cart-item-desc">
                          <span class="product-remove"><i class="fa fa-close" aria-hidden="true"></i></span>
                            <span class="badge">Mango</span>
                            <h6>Button Through Strap Mini Dress</h6>
                            <p class="size">Size: S</p>
                            <p class="color">Color: Red</p>
                            <p class="price">$45.00</p>
                        </div>
                    </a>
                </div>

                <!-- Single Cart Item -->
                <div class="single-cart-item">
                    <a href="#" class="product-image">
                        <img src="img/product-img/product-2.jpg" class="cart-thumb" alt="">
                        <!-- Cart Item Desc -->
                        <div class="cart-item-desc">
                          <span class="product-remove"><i class="fa fa-close" aria-hidden="true"></i></span>
                            <span class="badge">Mango</span>
                            <h6>Button Through Strap Mini Dress</h6>
                            <p class="size">Size: S</p>
                            <p class="color">Color: Red</p>
                            <p class="price">$45.00</p>
                        </div>
                    </a>
                </div>

                <!-- Single Cart Item -->
                <div class="single-cart-item">
                    <a href="#" class="product-image">
                        <img src="img/product-img/product-3.jpg" class="cart-thumb" alt="">
                        <!-- Cart Item Desc -->
                        <div class="cart-item-desc">
                          <span class="product-remove"><i class="fa fa-close" aria-hidden="true"></i></span>
                            <span class="badge">Mango</span>
                            <h6>Button Through Strap Mini Dress</h6>
                            <p class="size">Size: S</p>
                            <p class="color">Color: Red</p>
                            <p class="price">$45.00</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="cart-amount-summary">

                <h2>Summary</h2>
                <ul class="summary-table">
                    <li><span>subtotal:</span> <span>$274.00</span></li>
                    <li><span>delivery:</span> <span>Free</span></li>
                    <li><span>discount:</span> <span>-15%</span></li>
                    <li><span>total:</span> <span>$232.00</span></li>
                </ul>
                <div class="checkout-btn mt-100">
                    <a href="checkout.html" class="btn essence-btn">check out</a>
                </div>
            </div>
        </div>
    </div>
    <!-- ##### Right Side Cart End ##### -->

    <!-- ##### Breadcumb Area Start ##### -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item"><a href="/cart">Cart</a></li>
          <!-- <li class="breadcrumb-item"><a href="/shop">Shop</a></li> -->
          <li class="breadcrumb-item active" aria-current="page">Checkout</li>
        </ol>
      </nav>
    <!-- ##### Breadcumb Area End ##### -->

    <!-- ##### Checkout Area Start ##### -->
    <div class="checkout_area section-padding-80">
        <div class="container">
            <div class="row">

                <div class="col-12 col-md-6">
                    <div class="checkout_details_area clearfix">
                        <div class="cart-page-heading mb-30">
                            <h5>Shipping Address</h5>
                        </div>
                        <div class="shipping-address-container">
                        
                            <% for(let i = 0; i < address.length; i++) { %>
                                <div class="address-card">
                                    <div class="address-header">
                                        <input type="radio" id="address-radio-<%= i %>" name="shipping_address" value="<%= address[i]._id %>" 
                                            <% if (i === 0) { %> checked <% } %>>  
                                        
                                        <input type="hidden" id="addressId" value="<%= address[i]._id %>">
                                        <span class="address-type"><%= address[i].addressType %></span>
                                        <button onclick="openModalBtnonclick('<%= address[i]._id %>')" id="edit-btn" class="edit-btn">&#9998; Edit</button>
                                    </div> 
                                    <div class="address-details">
                                        <p><%= address[i].name %></p>
                                        <p>Landmark:<%= address[i].landMark %></p>
                                        <p>Pincode:<%= address[i].pincode %></p>
                                        <p><%= address[i].state %>,<%= address[i].city %></p>
                                        <p>&#9742; <%= address[i].phone %></p>
                                    </div>
                                </div>
                            <% } %>
                            
                            

                            <button onclick="openaddModalBtnonclick()" class="btn essence-btn">+ Add Another Address</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-md-6 col-lg-5 ml-lg-auto">

                    <div class="order-details-confirmation" style="margin-bottom: 10px;">

                        <ul class="order-details-form mb-4">
                            <li><span> Product</span> <span>Quantity</span> <span>Total</span></li>
                            
                            <% if (cart && cart.length > 0) { %>
                                <% for(let i = 0; i < cart.length; i++) { %>
                                    <li>
                                        <span><%= cart[i].productId ? cart[i].productId.productName : 'Unknown Product' %></span>
                                        <span><%= cart[i].quantity %></span>  
                                        <span><%= cart[i].quantity * cart[i].price %></span> 
                                    </li>
                                <% } %>
                            <% } else { %>
                                <li>No items in cart</li>
                            <% } %>
                        </ul>
                        

                    </div>


                    <div class="order-details-confirmation " style="margin-bottom: 10px;">
                        <ul class="order-details-form mb-4">
                            <li><span>Have a coupon ?</span></li>
                            <input type="text" class="form-control" id="coupon-input" value="">
                        </ul>
                        <div class="coupon-buttons">
                            <button onclick="applyCoupon()" id="apply-coupon-btn" class="btn coupon-btn apply-btn">Apply Coupon</button>
                            <button onclick="removeCoupon()" id="remove-coupon-btn" class="btn coupon-btn remove-btn">Remove Coupon</button>
                        </div>
                    </div>

                   <div class="order-details-confirmation" style="margin-bottom: 10px;">
                        <% if (couponData && couponData.length > 0) { %>
                            <ul class="order-details-form mb-4">
                                <li><span><strong>Available Coupons</strong></span></li>
                                <% couponData.forEach(coupon => { 
                                    let expiryDate = new Date(coupon.validTo);
                                    let isExpired = expiryDate < new Date(); // Check if expired
                                %>
                                    <% if (!isExpired) { %>  <!-- Only show non-expired coupons -->
                                        <li class="coupon-card border p-3 rounded mb-3">
                                            <div class="coupon-content">
                                                <p class="coupon-code"><strong>Code:</strong> <%= coupon.code %></p>
                                                <p class="coupon-discount"><strong>Discount:</strong> <%= coupon.discount %> <%= coupon.discountType %></p>
                                                <p class="coupon-min-purchase"><strong>Min Purchase:</strong> ₹<%= coupon.minPurchase %></p>
                                                <p class="coupon-expiry"><strong>Expires on:</strong> <%= expiryDate.toLocaleDateString('en-GB') %></p>
                                                <button class="btn btn-primary btn-block copy-btn mt-2" data-code="<%= coupon.code %>">Copy Code</button>
                                            </div>
                                        </li>
                                    <% } %>
                                <% }); %>
                            </ul>
                        <% } else { %>
                            <p class="text-muted">No coupons available.</p>
                        <% } %>
                    </div>
                    
                    <div class="order-details-confirmation" style="margin-bottom: 10px;">

                        <div class="cart-page-heading">
                            <h5>Your Order</h5>
                            <p>The Details</p>
                        </div>

                        <ul class="order-details-form mb-4">
                            <li><span>Subtotal</span> <span id="cart-subtotal" data-total="<%= cartTotal %>">₹ <%= cartTotal %></span></li>
                            <li><span>Shipping</span> <span>Free</span></li>
                            <li><span>Discount</span> <span id="discount-element">₹ 0</span></li>
                            <li><span>Total</span> <span id="total-element">₹ <%= cartTotal %></span></li>
                        </ul>

                    
                        <div id="payment-methods" class="mb-4">
                            <div class="card">
                                <div class="card-header" role="tab" id="headingOne">
                                    <h6 class="mb-0 payment-option">
                                        <label>
                                            <input type="radio" name="payment_method" value="upi">
                                            Razor Pay
                                        </label>
                                    </h6>
                                </div>
                            </div>
                        
                            <div class="card">
                                <div class="card-header" role="tab" id="headingTwo">
                                    <h6 class="mb-0 payment-option">
                                        <label id="payment_method_cod">
                                            <input type="radio" name="payment_method" value="cod">
                                            Cash on Delivery
                                        </label>
                                    </h6>
                                </div>
                            </div>
                        
        
                        </div>

                        <button href="#" onclick="placeOrder()" class="btn essence-btn">Place Order</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Address Modal -->

    <div id="myModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <form id="modalForm">
            <input type="hidden" id="addressId" value="<%= address._id %>">
            <div class="form-group">
              <label>Address Type</label>
              <div class="error-message" style="color: red;" id="addressTypeError"></div>
              <input type="text" class="form-control" name="addressType" id="addressType" value="<%= address.addressType %>">
            </div>
            <div class="form-group">
              <label>Name</label>
              <div class="error-message" style="color: red;" id="nameError"></div>
              <input type="text" class="form-control" name="name" id="name" value="<%= address.name %>">
            </div>  
            <div class="form-group">
              <label>City</label>
              <div class="error-message" style="color: red;" id="cityError"></div>
              <input type="text" class="form-control" name="city" id="city" value="<%= address.city %>">
            </div>
            <div class="form-group">
              <label>Landmark</label>
              <div class="error-message" style="color: red;" id="landMarkError"></div>
              <input type="text" class="form-control" name="landMark" id="landMark" value="<%= address.landMark %>">
            </div>
            <div class="form-group">
              <label>State</label>
              <div class="error-message" style="color: red;" id="stateError"></div>
              <input type="text" class="form-control" name="state" id="state" value="<%= address.state %>">
            </div>
            <div class="form-group">
              <label>Pincode</label>
              <div class="error-message" style="color: red;" id="pincodeError"></div>
              <input type="text" class="form-control" name="pincode" id="pincode" value="<%= address.pincode %>">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <div class="error-message" style="color: red;" id="phoneError"></div>
              <input type="text" class="form-control" name="phone" id="phone" value="<%= address.phone %>">
            </div>
            <div class="form-group">
              <label>Alternate Phone</label>
              <div class="error-message" style="color: red;" id="altphoneError"></div>
              <input type="text" class="form-control" name="altphone" id="altphone" value="<%= address.altphone %>">
            </div>
            <button type="submit" class="btn btn-submit" style="background-color: #0056b3; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px;">Update Address</button>
          </form>
        </div>
  </div>


      <!-- Add address Modal -->
      

      <div id="add-Modal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <form id="add-modalForm">
            <input type="hidden" id="add-addressId" value="<%= address._id %>">
            <div class="form-group">
              <label>Address Type</label>
              <div class="error-message" style="color: red;" id="add-addressTypeError"></div>
              <input type="text" class="form-control" name="add-addressType" id="add-addressType" value="">
            </div>
            <div class="form-group">
              <label>Name</label>
              <div class="error-message" style="color: red;" id="add-nameError"></div>
              <input type="text" class="form-control" name="name" id="add-name" value="">
            </div>  
            <div class="form-group">
              <label>City</label>
              <div class="error-message" style="color: red;" id="add-cityError"></div>
              <input type="text" class="form-control" name="city" id="add-city" value="">
            </div>
            <div class="form-group">
              <label>Landmark</label>
              <div class="error-message" style="color: red;" id="add-landMarkError"></div>
              <input type="text" class="form-control" name="landMark" id="add-landMark" value="">
            </div>
            <div class="form-group">
              <label>State</label>
              <div class="error-message" style="color: red;" id="add-stateError"></div>
              <input type="text" class="form-control" name="state" id="add-state" value="">
            </div>
            <div class="form-group">
              <label>Pincode</label>
              <div class="error-message" style="color: red;" id="add-pincodeError"></div>
              <input type="text" class="form-control" name="pincode" id="add-pincode" value="">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <div class="error-message" style="color: red;" id="add-phoneError"></div>
              <input type="text" class="form-control" name="phone" id="add-phone" value="">
            </div>
            <div class="form-group">
              <label>Alternate Phone</label>
              <div class="error-message" style="color: red;" id="add-altphoneError"></div>
              <input type="text" class="form-control" name="altphone" id="add-altphone" value="<%= address.altphone %>">
            </div>
            <button type="submit" class="btn btn-submit" style="background-color: #0056b3; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px;">Update Address</button>
          </form>
        </div>
  </div>
      


    <!-- ##### Checkout Area End ##### -->

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>


    <script>

        const totalElement=document.getElementById('total-element')
        const totalValue = parseFloat(totalElement.innerText.replace(/[^\d.]/g, ''));
        console.log(totalValue);

        if(totalValue>1000){
            document.getElementById("payment_method_cod").style.display = "none";
        }

        
            var modal = document.getElementById("myModal");
            var closeBtn = document.getElementsByClassName("close")[0];

            function openModalBtnonclick (addressId) {
                const addresses = JSON.parse('<%- JSON.stringify(address) %>');
                const address = addresses.find(addr => addr._id === addressId);

                if (address) {
                    document.getElementById("addressType").value = address.addressType || '';
                    document.getElementById("name").value = address.name || '';
                    document.getElementById("city").value = address.city || '';
                    document.getElementById("state").value = address.state || '';
                    document.getElementById("landMark").value = address.landMark || '';
                    document.getElementById("pincode").value = address.pincode || '';
                    document.getElementById("phone").value = address.phone || '';
                    document.getElementById("altphone").value = address.altPhone || '';   
                    document.getElementById("addressId").value = address._id;
                }

            modal.style.display = "block";
            }

            closeBtn.onclick = function() {
            modal.style.display = "none";
            }

            window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            }

//////////////////////////////////////////////////////////////////////////////////////////////

            //Add address

            var addmodal = document.getElementById("add-Modal");
            var addcloseBtn = document.getElementsByClassName("close")[0];

            function openaddModalBtnonclick () {
            addmodal.style.display = "block";
            }

            addcloseBtn.onclick = function() {
            addmodal.style.display = "none";
            }

            window.onclick = function(event) {
            if (event.target == modal) {
                addmodal.style.display = "none";
            }
            }

/////////////////////////////////////////////////////////////////////////////////////////////////////

            //Edit address
             
            document.getElementById("modalForm").addEventListener("submit", function(e) {
            e.preventDefault(); 
            
            let isValid=true;
            let fields = ["addressType", "name", "city", "state", "pincode", "phone", "altphone"];

            fields.forEach(field => {
                document.getElementById(field + "Error").textContent = "";
            });

            let addressType = document.getElementById("addressType").value.trim();
            let name = document.getElementById("name").value.trim();
            let city = document.getElementById("city").value.trim();
            let state = document.getElementById("state").value.trim();
            let pincode = document.getElementById("pincode").value.trim();
            let phone = document.getElementById("phone").value.trim();
            let altphone = document.getElementById("altphone").value.trim();
            let landMark = document.getElementById("landMark").value.trim();

            if (!addressType) {
                document.getElementById("addressTypeError").textContent = "Address Type is required.";
                isValid = false;
            }
            if (!name) {
                document.getElementById("nameError").textContent = "Name is required.";
                isValid = false;
            }
            if (!city) {
                document.getElementById("cityError").textContent = "City is required.";
                isValid = false;
            }
            if (!landMark) {
                document.getElementById("landMarkError").textContent = "Landmark is required.";
                isValid = false;
            }
            if (!state) {
                document.getElementById("stateError").textContent = "State is required.";
                isValid = false;
            }
            if (!pincode || !/^[0-9]{6}$/.test(pincode)) {
                document.getElementById("pincodeError").textContent = "Pincode must be a 6-digit number.";
                isValid = false;
            }
            if (!phone || !/^[0-9]{10}$/.test(phone)) {
                document.getElementById("phoneError").textContent = "Phone number must be a 10-digit number.";
                isValid = false;
            }
            if (altphone && !/^[0-9]{10}$/.test(altphone)) {
                document.getElementById("altphoneError").textContent = "Alternate phone number must be a 10-digit number.";
                isValid = false;
            }

            if(isValid){
            sendFormData()
            modal.style.display = "none"; 
            }


            });

        function sendFormData(){
            let formData = {
            addressType: document.getElementById("addressType").value.trim(),
            name: document.getElementById("name").value.trim(),
            city: document.getElementById("city").value.trim(),
            state: document.getElementById("state").value.trim(),
            pincode: document.getElementById("pincode").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            landMark: document.getElementById("landMark").value.trim(),
            altphone: document.getElementById("altphone").value.trim(),
            addressId: document.getElementById("addressId").value.trim() 
            };

            

            $.ajax({
            type:'post',
            url: '/editAddress', 
            dataType:'json',
            contentType: "application/json",
            data: JSON.stringify(formData),
            success:function(response){
                if(response.success){
                    Swal.fire({
                icon:'success',
                title:'Success',
                text: response.message,
                showConfirmButton:false,
                timer:1500
                })
                setTimeout(()=>{
                window.location.reload()
                },2000)
                }
            else{
                Swal.fire({
                icon:'error',
                title:'Error',
                text:response.message
                })
            }
            },
            error:function(){
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong. Please try again.'
                });
                }   


            })

            }

            
            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////

            //Add address

            document.getElementById("add-modalForm").addEventListener("submit", function(e) {
            e.preventDefault(); 
            
            let isValid=true;
            let fields = ["add-addressType", "add-name", "add-city", "add-state", "add-pincode", "add-phone", "add-altphone"];

            fields.forEach(field => {
                document.getElementById(field + "Error").textContent = "";
            });

            let addressType = document.getElementById("add-addressType").value.trim();
            let name = document.getElementById("add-name").value.trim();
            let city = document.getElementById("add-city").value.trim();
            let state = document.getElementById("add-state").value.trim();
            let pincode = document.getElementById("add-pincode").value.trim();
            let phone = document.getElementById("add-phone").value.trim();
            let altphone = document.getElementById("add-altphone").value.trim();
            let landMark = document.getElementById("add-landMark").value.trim();

            if (!addressType) {
                document.getElementById("add-addressTypeError").textContent = "Address Type is required.";
                isValid = false;
            }
            if (!name) {
                document.getElementById("add-nameError").textContent = "Name is required.";
                isValid = false;
            }
            if (!city) {
                document.getElementById("add-cityError").textContent = "City is required.";
                isValid = false;
            }
            if (!landMark) {
                document.getElementById("add-landMarkError").textContent = "Landmark is required.";
                isValid = false;
            }
            if (!state) {
                document.getElementById("add-stateError").textContent = "State is required.";
                isValid = false;
            }
            if (!pincode || !/^[0-9]{6}$/.test(pincode)) {
                document.getElementById("add-pincodeError").textContent = "Pincode must be a 6-digit number.";
                isValid = false;
            }
            if (!phone || !/^[0-9]{10}$/.test(phone)) {
                document.getElementById("add-phoneError").textContent = "Phone number must be a 10-digit number.";
                isValid = false;
            }
            if (altphone && !/^[0-9]{10}$/.test(altphone)) {
                document.getElementById("add-altphoneError").textContent = "Alternate phone number must be a 10-digit number.";
                isValid = false;
            }

            if(isValid){
            sendAddFormData()
            modal.style.display = "none"; 
            }


            });

        function sendAddFormData(){
            let formData = {
            addressType: document.getElementById("add-addressType").value.trim(),
            name: document.getElementById("add-name").value.trim(),
            city: document.getElementById("add-city").value.trim(),
            state: document.getElementById("add-state").value.trim(),
            pincode: document.getElementById("add-pincode").value.trim(),
            phone: document.getElementById("add-phone").value.trim(),
            landMark: document.getElementById("add-landMark").value.trim(),
            altphone: document.getElementById("add-altphone").value.trim(),
            addressId: document.getElementById("add-addressId").value.trim() 
            };

            

            $.ajax({
            type:'post',
            url: '/add-address', 
            dataType:'json',
            contentType: "application/json",
            data: JSON.stringify(formData),
            success:function(response){
                if(response.success){
                    Swal.fire({
                icon:'success',
                title:'Success',
                text: response.message,
                showConfirmButton:false,
                timer:1500
                })
                setTimeout(()=>{
                window.location.reload()
                },2000)
                }
            else{
                Swal.fire({
                icon:'error',
                title:'Error',
                text:response.message
                })
            }
            },
            error:function(){
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong. Please try again.'
                });
                }   


            })

            }

            

            async function placeOrder() {
                try {
                    // 1. Input Validation
                    const shippingAddress = document.querySelector('input[name="shipping_address"]:checked')?.value;
                    const paymentMethod = document.querySelector('input[name="payment_method"]:checked')?.value;
                    const totalPrice = parseFloat(document.getElementById('cart-subtotal').textContent.replace('₹', '').trim()) || 0;
                    const discountAmount= parseFloat(document.getElementById('discount-element').textContent.replace('₹', '').trim()) || 0
                    const cartItems = JSON.parse('<%- JSON.stringify(cartItems) %>');
                    const couponInput = document.getElementById('coupon-input');
                    let couponCode = null;

                    if (!shippingAddress) {
                        Swal.fire({
                            icon: "warning",
                            title: "Missing Address",
                            text: "Please select a shipping address."
                        });
                        return;
                    }

                    if (!paymentMethod) {
                        Swal.fire({
                            icon: "warning",
                            title: "Missing Payment Method",
                            text: "Please select a payment method."
                        });
                        return;
                    }

                    if (!totalPrice || totalPrice <= 0) {
                        Swal.fire({
                            icon: "error",
                            title: "Invalid Order Amount",
                            text: "The total price must be greater than zero."
                        });
                        return;
                    }

                    if (!cartItems || !cartItems.length) {
                        Swal.fire({
                            icon: "warning",
                            title: "Empty Cart",
                            text: "Your cart is empty. Please add items before placing an order."
                        });
                        return;
                    }

                    if (document.getElementById('apply-coupon-btn').disabled) {
                        couponCode = couponInput.value.trim();
                    }

                    // 2. Handle Cash on Delivery
        if (paymentMethod === "cod") {
            const confirmResult = await Swal.fire({
                title: "Confirm Order",
                text: "Do you want to place the order?",
                icon: "info",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, place order!",
                cancelButtonText: "Cancel"
            });

            if (!confirmResult.isConfirmed) {
                return;
            }

            const response = await fetch('/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    addressId: shippingAddress, 
                    paymentMethod, 
                    totalPrice, 
                    cartItems, 
                    discountAmount,
                    couponCode 
                })
            });
            
            const data = await response.json();
            if (data.success) {
                await Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: data.message,
                    showConfirmButton: false,
                    timer: 1500
                });
                window.location.href = '/orders';
            } else {
                await Swal.fire({
                    icon: 'info',
                    title: 'Info',
                    text: data.message,
                    showConfirmButton: true,
                });
            }
            return;
        }

        // 3. Handle Razorpay Payment
        const orderResponse = await fetch("/create-order", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
                amount: totalPrice-discountAmount,
                currency: "INR"
            })
        });

        if (!orderResponse.ok) {
            throw new Error(`Server error: ${orderResponse.status}`);
        }

        const orderData = await orderResponse.json();
        if (!orderData.success) {
            throw new Error(orderData.message || 'Failed to create order');
        }

        // 4. Initialize Razorpay
            const options = {
                key: orderData.key,
                amount: orderData.amount,
                currency: orderData.currency,
                name: "Filmatic",
                description: "Order Payment",
                order_id: orderData.order_id,
                handler: async function (response) {
                    try {
                        if (!response.razorpay_payment_id || !response.razorpay_order_id || !response.razorpay_signature) {
                            throw new Error("Invalid payment response from Razorpay");
                        }

                        const verifyResponse = await fetch("/verify-payment", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_signature: response.razorpay_signature,
                                addressId: shippingAddress,
                                totalPrice,
                                cartItems: cartItems.map(item => ({
                                    productName: item.productName,
                                    productId: item.productId._id || item.productId,
                                    quantity: item.quantity,
                                    price: item.price,
                                    totalPrice: item.totalPrice
                                })),
                                couponCode,
                                discountAmount
                            })
                        });

                        if (!verifyResponse.ok) {
                            throw new Error(`Server error: ${verifyResponse.statusText}`);
                        }

                        const verifyData = await verifyResponse.json();
                        if (!verifyData.success) {
                            throw new Error(verifyData.message || 'Payment verification failed');
                        }

                        await Swal.fire({
                            icon: 'success',
                            title: 'Payment Successful',
                            text: 'Your order has been placed!',
                            showConfirmButton: false,
                            timer: 1500
                        });

                        window.location.href = '/orders';

                    } catch (error) {
                        await Swal.fire({
                            icon: 'error',
                            title: 'Payment Verification Failed',
                            text: error.message || 'Please contact support if payment was deducted'
                        });
                    }
                },
                prefill: {
                    name: "<%= user.name %>",
                    email: "<%= user.email %>",
                    contact: "<%= user.phone %>"
                },
                theme: {
                    color: "#3399cc"
                },
                modal: {  
                ondismiss: async function() {
                    await fetch("/verify-payment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            razorpay_order_id: orderData.order_id,
                            razorpay_payment_id: null, 
                            razorpay_signature: null,
                            addressId: shippingAddress,
                            totalPrice,
                            cartItems: cartItems.map(item => ({
                                productName: item.productName,
                                productId: item.productId._id || item.productId,
                                quantity: item.quantity,
                                price: item.price,
                                totalPrice: item.totalPrice
                            })),
                            couponCode,
                            discountAmount
                        })
                    });

                        rzp.close();
                 
                    await Swal.fire({
                        icon: 'error',
                        title: 'Payment Failed',
                        text: 'Your payment has failed.',
                        showConfirmButton: false,
                        timer: 2000
                    });

                    

                    window.location.href = "/orders";
                }
            }

            };

            const rzp = new Razorpay(options);
            rzp.open();



    } catch (error) {
        await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Something went wrong. Please try again.'
        });
    }
}


        document.querySelectorAll('.copy-btn').forEach(button => {
        button.addEventListener('click', function() {
            const couponCode = this.getAttribute('data-code');
            navigator.clipboard.writeText(couponCode).then(() => {
                Toastify({
                    text: "Coupon code copied: " + couponCode,
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    stopOnFocus: true
                }).showToast();
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        });
    });


    async function applyCoupon() {
        try {

            const couponInput = document.getElementById('coupon-input');
            const couponCode = couponInput.value.trim(); 

            if (!couponCode) {
                Toastify({
                    text: "Please enter a coupon code!",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "red",
                    stopOnFocus: true
                }).showToast();
                return;     
            }


            const subtotal = parseFloat(document.getElementById('cart-subtotal').getAttribute('data-total'));

                const response=await fetch('/applyCoupon',{
                method:'POST',
                headers: {'Content-Type': 'application/json'},
                body:JSON.stringify({couponCode:couponCode,subtotal:subtotal})
                })

                const data=await response.json()


                if(data.success){

                    const discountElement=document.getElementById('discount-element')
                    discountElement.textContent = `₹ ${data.discountAmount.toFixed(2)}`;
                    const totalElement=document.getElementById('total-element')
                    totalElement.textContent = `₹ ${(data.finalTotal).toFixed(2)}`;

                    couponInput.disabled = true;
                    document.getElementById('apply-coupon-btn').disabled = true;


                    Toastify({
                    text: data.message,
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "green",
                    stopOnFocus: true
                }).showToast();
                }
                else{
                    Toastify({
                    text: data.message,
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "red",
                    stopOnFocus: true
                }).showToast();
                }
            }


            catch (error) {
                console.error('Error:', error);
                    Toastify({
                        text: "Something went wrong. Please try again.",
                        duration: 2000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "red",
                        stopOnFocus: true
                    }).showToast();      
            }
    }


    async function removeCoupon() {
            try {
                const couponInput = document.getElementById('coupon-input');
                const discountElement = document.getElementById('discount-element');
                const totalElement = document.getElementById('total-element');
                const applyButton = document.getElementById('apply-coupon-btn');

                if (!couponInput.disabled) {
                    Toastify({
                        text: "No coupon applied!",
                        duration: 2000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "red",
                        stopOnFocus: true
                    }).showToast();
                    return;
                }

                // Restore original values
                couponInput.value = "";
                couponInput.disabled = false;
                applyButton.disabled = false;

                const subtotal = parseFloat(document.getElementById('cart-subtotal').getAttribute('data-total'));

                discountElement.textContent = "₹ 0.00"; 
                totalElement.textContent = `₹ ${subtotal.toFixed(2)}`; 

                Toastify({
                    text: "Coupon removed successfully!",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "orange",
                    stopOnFocus: true
                }).showToast();

            } catch (error) {
                console.error("Error:", error);
                Toastify({
                    text: "Something went wrong. Please try again.",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "red",
                    stopOnFocus: true
                }).showToast();
            }
        }

    </script>

    <%- include("../../views/partials/user/footer") %>
